<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="x-ua-compatible" content="IE=edge">
	<title>Predicted Water Levels</title>
	<script src="/scripts/jquery-1.9.1.js"></script>
	<script src="/scripts/jquery.ui.core.js"></script>
	<!-- <script src="/scripts/jquery.ui.datepicker.js"></script> -->
	<!-- <script src="/scripts/jquery.dataTables.min.js"></script> -->
	<script src="/scripts/moment.min.js"></script>
	<!-- <script src="/scripts/moment.fr-ca.js"></script> -->
	<script src="/scripts/flot/jquery.flot.js"></script>
	<script src="/scripts/flot/jquery.flot.time.js"></script>
	<script src="/scripts/flot/jquery.flot.axislabels.js"></script>
	<!-- <script src="/scripts/avadepth.js"></script> -->
	<!-- <script src="/scripts/pwl_func.js"></script> -->

	<link rel="stylesheet" type="text/css" href="/wet-boew/dist/js/css/pe-ap-min.css">
	<link rel="stylesheet" type="text/css" href="/wet-boew/dist/grids/css/util-min.css">
	<link rel="stylesheet" type="text/css" href="/css/custom.css">
	<link rel="stylesheet" type="text/css" href="/wet-boew/dist/theme-gcwu-fegc/css/theme-min.css">

	<style type="text/css" media="screen">
		.span-8 {
			width: 98%;
		}
		#verify_wrapper {
			display: table;
			margin: 0 auto;
		}
		.print_holder {
			display: -webkit-box;
			display: -moz-box;
			display: -ms-flexbox;
			display: -webkit-flex;
			display: flex;
			height: 50px;
		}
		.button {
			height: 26px;
			margin: auto;
		}
	</style>

	<style type="text/css" media="print">
		.button {
			display: none;
		}
	</style>

	<script>
		$(document).ready(function() {
			if (opener.document) {
				var parentElem = window.opener.$("#detail_content").clone();
				if ((/Trident\/7\./).test(navigator.userAgent) ||
					(/MSIE/).test(navigator.userAgent)) {
					var outer = parentElem[0].outerHTML;
					$('#detail_content_popup')[0].innerHTML = outer;
				} else {
					$('#detail_content_popup').html(parentElem);
				}
				console.log(parentElem);
			}
			$('button[name="print"]').click(function() {
				window.print()
			});
			var closeButton = $('<input type="button" class="button button-accent" value="Close" onClick="window.close()">');
			$('.print_holder').append(closeButton);

			$('#det_placeholder').empty();

			//TODO: Copy and refactor code from pwl_func.gotoGraph_sub

			function getUrlParameter(param) {
				var url = decodeURIComponent(window.location.search.substring(1));
				var vars = url.split('&');
				var paramName;
				for (var i = 0; i < vars.length; i++) {
					paramName = vars[i].split('=');
					if (paramName[0] === param) {
						return paramName[1] === undefined ? true : paramName[1];
					}
				}
			};

			function getAPI(extURL, intURL){
				if(document.URL.split("/")[2].split(":")[0] === "localhost") {
					return intURL;
				} else {
					return extURL;
				}
			};

			var typCode, typValue, waterway, date, intervalMin, flowRate, flowType, waterway, static_arm, static_interval;

			function setParameters() {
				typCode = getUrlParameter("code");
				typValue = getUrlParameter("value");
				waterway = getUrlParameter("waterway");
				date = getUrlParameter("date");
				intervalMin = getUrlParameter("intervalMin");
				flowRate = getUrlParameter("flowRate");
				flowType = getUrlParameter("flowType");
				waterway = getUrlParameter("waterway");
				static_arm = "South Arm";
				static_interval = "1 Hour";
			}

			function gotoGraph() {
				setParameters();

				var detkmtime = $('#det_km_time');
				switch (waterway) {
					case '0':
						$('#det_river-section').text("South Arm");
						break;
					case '1':
						$('#det_river-section').text("North Arm");
						break;
					case '2':
						$('#det_river-section').text("Main Arm");
						break;
				}
				$('#det_km_time').text(typValue);
				$('#det_static-date').text(moment(date).format("MMM D, YYYY"));
				$('#det_static-interval').text(static_interval);
				$('#det_static-arm').text(static_arm);
				$('#det_static-discharge').text(flowRate);
				$('#det_static-discharge-eval').text(translate_flow());

				gotoGraph_sub(typCode, typValue, "#det_placeholder"); // create pwl plots for main detail report
			};

			function translate_flow() {
				var flow = "";
				if (window.location.href.indexOf("fra") > -1) {
					switch($("#flowType").val()) {
					case "Predicted":
						flow = "Prévu";
						break;
					case "Actual":
						flow = "Réel";
						break;
					case "Selected":
						flow = "Choisi";
						break;
					case "UserDefined":
						flow = "Défini par l'utilisateur";
						break;
					default:
						flow = "N/A"
						break;
					}
				} else if ($("#flowType").val() === "UserDefined"){
					flow = "User-defined";
				} else {
					flow = $("#flowType").val()
				}

				return flow;
			}

			function gotoGraph_sub(typCode, typValue, plotId) {
				var step = (function() {
					var t;
					switch (waterway) {
						case '0':
							t = [(typValue / 2), 2];
							break;
						case '1':
							t = [(typValue / 2), 2];
							break;
						case '2':
							t = [((typValue - 40) / 4), 4];
							break;
					}
					return t[typCode];
				})();


				// if using IE, make tweaks
				$(plotId).css('font-size', 'inherit');

				if (typCode == 0) {
					$('#det_km_time-suff').text(' km ');

					//TODO: Replace following line for production
					$.getJSON(getAPI(("/api/waterlevel?date=" + (date) + "&") + ("intervalMin=" + (intervalMin) + "&") + ("flowRate=" + (flowRate) + "&") + ("flowType=" + (flowType) + "&") + ("waterway=" + (waterway) + "&") + "displayType=0", "api/depths/waterlevel_kmplot.json"), function(data) {
						//$.getJSON(("/api/waterlevel?date=" + ($('#pwl_date').val()) + "&") + ("intervalMin=" + ($('#interval').val()) + "&") + ("flowRate=" + ($('#flowRate').val()) + "&") + ("flowType=" + ($('#flowType').val()) + "&") + ("waterway=" + ($('#pwl_waterway').val()) + "&") + "displayType=0", function(data) {
						//$.getJSON("api/depths/waterlevel_kmplot.json", function (data) {
						var points = [];
						$.each(data.times, function() {
							var date;
							if (this.predictTime !== '24:00') {
								date = new Date("January 1, 2000 " + this.predictTime);
							} else {
								date = new Date("January 2, 2000 00:00");
							}
							return points.push([date.getTime(), this.waterLevels[step]]);
						});
						console.log("Points processed...");
						return $.plot($(plotId), [points], {
							xaxis: {
								color: 'black',
								tickColor: '#ddd',
								mode: 'time',
								tickSize: [4, "hour"],
								timezone: "browser",
								axisLabel: 'Pacific Standard Time (PST)'
							},
							yaxis: {
								color: 'black',
								tickColor: '#ddd',
								position: 'left',
								axisLabel: 'Water Level (metres) relative to LWD'
							}
						});
					});
				} else {
					$('#det_km_time-suff').text('');

					//TODO: Replace following line for production
					$.getJSON(getAPI(("/api/waterlevel?date=" + (date) + "&") + ("intervalMin=" + (intervalMin) + "&") + ("flowRate=" + (flowRate) + "&") + ("flowType=" + (flowType) + "&") + ("waterway=" + (waterway) + "&") + "displayType=0", "api/depths/waterlevel_timeplot.json"), function(data) {
						//$.getJSON(("/api/waterlevel?date=" + ($('#pwl_date').val()) + "&") + ("intervalMin=" + ($('#interval').val()) + "&") + ("flowRate=" + ($('#flowRate').val()) + "&") + ("flowType=" + ($('#flowType').val()) + "&") + ("waterway=" + ($('#pwl_waterway').val()) + "&") + "displayType=0", function(data) {
						//$.getJSON("api/depths/waterlevel_timeplot.json", function (data) {
						var points = [];
						$.each(data.times, function() {
							var start;
							if (this.predictTime === typValue) {
								start = 0;
								if (step === 4) {
									start = 40;
								}
								return $.each(this.waterLevels, function(i) {
									return points.push([i * step + start, this]);
								});
							}
						});
						return $.plot($(plotId), [points], {
							xaxis: {
								color: 'black',
								tickColor: '#ddd',
								tickSize: step,
								axisLabel: 'Location (km)'
							},
							yaxis: {
								color: 'black',
								tickColor: '#ddd',
								position: 'left',
								axisLabel: 'Water Level (metres) relative to LWD'
							}
						});
					});
				}
			};
			gotoGraph();
		});
	</script>
</head>
<body>
	<div id="detail_content_popup">
		<div class="grid-12">
            <div class="span-6 align-center">
			  <h2>Predicted Water Levels<br/>Fraser River - <span id="det_river-section"></span> at <span id="det_km_time-suff"></span><span id="det_km_time"></span></h2>
              <p><span id="det_static-date"></span> at <span id="det_static-interval"></span> Intervals<br/>River Discharge @ Hope <span id="det_static-discharge"></span>&#179;/s (<span id="det_static-discharge-eval"></span>)</p>
              <div id="det_placeholder" class="demo-placeholder" style="height:450px;width:800px;"></div>
            </div>
          </div>
	</div>
</body>
</html>
